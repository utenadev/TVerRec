# PowerShellからGoへのリライト分析

TVerRecの現在のPowerShellベース実装をGo言語で書き直すことについての技術的な分析、手順、および潜在的な問題点を以下にまとめる。

**前提条件:**
- **GUIは実装せず、CLI (コマンドラインインターフェース) 専用ツールとして再設計する。**
- **通知機能はWindowsのトースト通知から、`utenadev/discat` を利用したDiscordへのWebhook通知に切り替える。**

## 1. 分析

### Goへ書き換えるメリット (Pros)

1.  **パフォーマンス**: Goはコンパイル言語であり、並行処理（Goroutine）に優れているため、特に複数の動画を同時にダウンロード・処理する際のパフォーマンス向上が期待できる。
2.  **クロスコンパイル**: Goはクロスコンパイルが非常に容易であり、単一のコマンドでWindows, macOS, Linux向けの実行ファイルを生成できる。これにより、各OSでPowerShell Coreの実行環境を要求する必要がなくなり、単一のバイナリファイル配布が可能になる。
3.  **静的型付け**: Goは静的型付け言語であり、コンパイル時に多くのエラーを検出できるため、コードの堅牢性や保守性が向上する。
4.  **依存関係の単純化**: 利用ユーザーはGoの実行環境をインストールする必要がなく、単一の実行ファイルをダウンロードするだけで済む。PowerShell Core, .NETランタイムといった外部依存が不要になる。
5.  **エコシステム**: Web APIとの連携やJSONの扱いは、Goの標準ライブラリで非常に効率的に行える。
6.  **通知機能の集約**: Discordへの通知に切り替えることで、OS固有の通知実装が不要になり、クロスプラットフォームで一貫した通知体験を提供できる。

### Goへ書き換えるデメリット (Cons)

1.  **Windows固有機能の扱い**: `Unblock-File`（Mark-of-the-Webの解除）など、一部のWindows固有の便利機能は、Goで同等の機能を実現するためにより複雑な実装が必要になるか、あるいは機能を省略する判断が必要になる。
2.  **スクリプトベースの柔軟性の喪失**: PowerShellはスクリプト言語であり、ユーザーがある程度コードを読んで改変することが容易。コンパイル言語であるGoに移行すると、この柔軟性は失われる。
3.  **開発工数**: GUIを考慮しないとしても、既存のコアロジックをすべてGoで書き直すのは相応の開発工数がかかる。特に`yt-dlp`や`ffmpeg`の呼び出しと、その出力の解析部分は慎重な再実装が求められる。
4.  **既存GUIユーザーの移行**: 現在GUI版を利用しているユーザーは、CLIのみの利用へと移行する必要がある。

## 2. リライト手順の提案

1.  **プロジェクト設定**: Goのプロジェクト（モジュール）を初期化し、基本的なディレクトリ構造を設計する。
2.  **設定ファイルの再設計**: 現在の `.ps1` 形式の設定ファイルを、Goで扱いやすい形式（例: `config.yaml`, `config.toml`）に移行する。移行ツールまたは手動での変換手順をユーザーに提供する必要がある。
3.  **CLI（コマンドラインインターフェース）の実装**: `cobra` や `urfave/cli` などのライブラリを使用し、現在の `win/*.cmd` や `unix/*.sh` が提供する各機能をサブコマンドとして実装する (`tverrec download bulk`, `tverrec loop` など)。
4.  **コアロジックの移植**:
    a.  TVer APIとの通信部分を、Goの`net/http`パッケージを使って実装する。
    b.  `yt-dlp` と `ffmpeg` を外部プロセスとして呼び出し、その標準出力・エラー出力を監視・制御するロジックを `os/exec` パッケージで実装する。並列実行はGoroutineで管理する。
    c.  `history.csv` などのデータファイルの読み書きロジックを実装する。
5.  **通知機能の実装**:
    *   ダウンロード開始、完了、エラーなどのイベント発生時に、外部コマンド `discat` を呼び出す処理を実装する。
    *   設定ファイルでDiscordのWebhook URLや通知内容のテンプレートを管理できるようにする。
6.  **テスト**: Goの標準テスト機能 (`go test`) を使い、各機能の単体テストと統合テストを作成する。
7.  **ビルドと配布**: GitHub Actionsなどを使って、各OS向けのバイナリを自動でビルドし、リリースするパイプラインを構築する。

## 3. 潜在的な問題点と課題

-   **互換性の維持**: 設定ファイルやデータファイルの形式を変更する場合、旧バージョンからのスムーズな移行パスをユーザーに提供する必要がある。
-   **PowerShell特有の処理**: PowerShellのパイプラインやオブジェクト処理を多用している部分がある場合、Goの思想に合わせた再設計が必要になる。単純な1対1の移植は難しい場面が想定される。
-   **コミュニティの知識**: TVerの仕様など、現在のコミュニティが持つPowerShellベースの知識や資産を、Goに移行する際にどう引き継ぐかという課題もある。
-   **外部コマンドへの依存**: 通知機能を `discat` に依存することで、ユーザーは `discat` を別途インストールし、パスを通す必要が出てくる。このツールのメンテナンス状況にも将来的に影響を受ける可能性がある。
