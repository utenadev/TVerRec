# PowerShellからGoへのリライト分析

TVerRecの現在のPowerShellベース実装をGo言語で書き直すことについての技術的な分析、手順、および潜在的な問題点を以下にまとめる。

## 1. 分析

### Goへ書き換えるメリット (Pros)

1.  **パフォーマンス**: Goはコンパイル言語であり、並行処理（Goroutine）に優れているため、特に複数の動画を同時にダウンロード・処理する際のパフォーマンス向上が期待できる。
2.  **クロスコンパイル**: Goはクロスコンパイルが非常に容易であり、単一のコマンドでWindows, macOS, Linux向けの実行ファイルを生成できる。これにより、各OSでPowerShell Coreの実行環境を要求する必要がなくなり、単一のバイナリファイル配布が可能になる。
3.  **静的型付け**: Goは静的型付け言語であり、コンパイル時に多くのエラーを検出できるため、コードの堅牢性や保守性が向上する。
4.  **依存関係の単純化**: 利用ユーザーはGoの実行環境をインストールする必要がなく、単一の実行ファイルをダウンロードするだけで済む。PowerShell Core, .NETランタイムといった外部依存が不要になる。
5.  **エコシステム**: Web APIとの連携やJSONの扱いは、Goの標準ライブラリで非常に効率的に行える。

### Goへ書き換えるデメリット (Cons)

1.  **GUIの再実装**: 現在のWindows版GUIはPowerShellとWPF/XAMLで実装されている。Goには標準のGUIツールキットがなく、この部分を直接移植することは不可能。GUIを提供し続けるには、WailsやFyneのようなサードパーティのGo向けツールキットを使って、GUIをゼロから再実装する必要がある。これはプロジェクトで最も困難な作業となる。
2.  **Windows固有機能の喪失**: `Unblock-File`（Mark-of-the-Webの解除）やトースト通知など、PowerShellで容易に実現できるWindows固有の機能は、Goで同等の機能を実現するためにOSのAPIを直接呼び出すなど、より複雑な実装が必要になる。
3.  **スクリプトベースの柔軟性の喪失**: PowerShellはスクリプト言語であり、ユーザーがある程度コードを読んで改変することが容易。コンパイル言語であるGoに移行すると、この柔軟性は失われる。
4.  **開発工数**: 既存のロジックをすべてGoで書き直すのは、相応の開発工数がかかる。特に`yt-dlp`や`ffmpeg`の呼び出しと、その出力の解析部分は慎重な再実装が求められる。

## 2. リライト手順の提案

1.  **プロジェクト設定**: Goのプロジェクト（モジュール）を初期化し、基本的なディレクトリ構造を設計する。
2.  **設定ファイルの再設計**: 現在の `.ps1` 形式の設定ファイルを、Goで扱いやすい形式（例: `config.yaml`, `config.toml`）に移行する。移行ツールまたは手動での変換手順をユーザーに提供する必要がある。
3.  **CLI（コマンドラインインターフェース）の実装**: `cobra` や `urfave/cli` などのライブラリを使用し、現在の `win/*.cmd` や `unix/*.sh` が提供する各機能をサブコマンドとして実装する (`tverrec download bulk`, `tverrec loop` など)。
4.  **コアロジックの移植**:
    a.  TVer APIとの通信部分を、Goの`net/http`パッケージを使って実装する。
    b.  `yt-dlp` と `ffmpeg` を外部プロセスとして呼び出し、その標準出力・エラー出力を監視・制御するロジックを `os/exec` パッケージで実装する。並列実行はGoroutineで管理する。
    c.  `history.csv` などのデータファイルの読み書きロジックを実装する。
5.  **GUIの実装（最難関）**:
    *   **方針決定**: CLI版のみとするか、GUIも提供するかを決定する。
    *   **技術選定**: GUIを提供する場合、Wails（Web技術ベース）や Fyne（ネイティブウィジェット）などのツールキットを選定する。Wailsは既存のWeb開発スキルを活かせるため、比較的学習コストが低い可能性がある。
    *   **実装**: 選定したツールキットを使い、設定画面や実行状況を表示するGUIを新規に開発する。
6.  **テスト**: Goの標準テスト機能 (`go test`) を使い、各機能の単体テストと統合テストを作成する。
7.  **ビルドと配布**: GitHub Actionsなどを使って、各OS向けのバイナリを自動でビルドし、リリースするパイプラインを構築する。

## 3. 潜在的な問題点と課題

-   **最重要課題: GUIの実現性**: GoでのクロスプラットフォームGUI開発はまだ発展途上であり、PowerShell+WPFほどの完成度や安定性を得るには時間がかかる可能性がある。GUIがこのツールの重要な要素である場合、リライトの大きな障壁となる。WebベースのUI（Wailsなど）に割り切ることで、クロスプラットフォーム対応は容易になるが、ネイティブアプリとは使用感が異なる。
-   **互換性の維持**: 設定ファイルやデータファイルの形式を変更する場合、旧バージョンからのスムーズな移行パスをユーザーに提供する必要がある。
-   **PowerShell特有の処理**: PowerShellのパイプラインやオブジェクト処理を多用している部分がある場合、Goの思想に合わせた再設計が必要になる。単純な1対1の移植は難しい場面が想定される。
-   **コミュニティの知識**: TVerの仕様など、現在のコミュニティが持つPowerShellベースの知識や資産を、Goに移行する際にどう引き継ぐかという課題もある。
