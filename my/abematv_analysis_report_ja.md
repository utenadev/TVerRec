# AbemaTVエクストラクタの分析とTVerとの比較

## はじめに

このレポートは、`yt-dlp`のAbemaTV用エクストラクタ（`abematv.py`）を分析し、その機能と複雑性を、特にTVer用エクストラクタ（`tver.py`）との比較を通じて明らかにすることを目的としています。最終的な目標は、AbemaTVがTVerと同様の方法で動画ダウンロードのターゲットとなりうるかを理解することです。

## TVerエクストラクタ（`tver.py`）の分析

TVerエクストラクタは比較的単純です。その主な特徴は以下の通りです。

*   **サードパーティプラットフォームへの依存:** TVerは動画を直接ホスティングせず、**Brightcove**や**Streaks**といった主要な動画プラットフォームを利用しています。`yt-dlp`のTVerエクストラクタは、主にこれらのプラットフォームへの橋渡し役として機能します。
*   **シンプルなAPI連携:** エクストラクタはTVerの公開API（`platform-api.tver.jp`, `service-api.tver.jp`）を呼び出し、エピソードやシリーズに関するメタデータを取得します。
*   **DRM/抽出処理の委任:** 動画の参照IDを取得した後、実際の動画抽出やDRMの処理は`yt-dlp`内の他の汎用的なInfoExtractor（例: `BrightcoveNewIE`, `StreaksBaseIE`）に委任します。`tver.py`のコード自体には、複雑な動画復号ロジックは含まれていません。
*   **シンプルな認証:** APIとの通信のために、ユーザー固有ではない単純なセッションを確立します。ユーザーログインの処理は行いません。

要するに、TVerがターゲットとして対応しやすいのは、標準的で広くサポートされている動画配信プラットフォームを基盤としているためです。

## AbemaTVエクストラクタ（`abematv.py`）の分析

AbemaTVエクストラクタは著しく複雑であり、高度なカスタムエンジニアリングが施されています。

*   **独自インフラストラクチャ:** AbemaTVは独自のAPI（`api.abema.io`）、独自のライセンスサーバー（`license.abema.io`）、そしてカスタムセキュリティで保護されたCDNセットアップを使用しています。標準的なサードパーティの動画プラットフォームは利用していません。
*   **複雑な認証:** エクストラクタは、まず一意のデバイスIDを生成する必要があります。次に、ハードコードされた秘密鍵（`_SECRETKEY`）と、時刻に基づく複雑なHMACハッシュアルゴリズム（`_generate_aks`）を用いてアプリケーションキーを生成します。このキーを使ってデバイスを認証し、ユーザートークンを取得します。このトークンは、再生に必要となる一時的なメディアトークンと交換されます。さらに、プレミアムコンテンツ向けにユーザーのメールアドレス/パスワードによるログインも完全にサポートしています。
*   **カスタムDRMの実装:** これが最も重大な違いです。AbemaTVは**独自開発のカスタムDRMシステム**を使用しています。`yt-dlp`のエクストラクタには、このDRMスキームをリバースエンジニアリングして再実装したコードが完全に含まれています。そのプロセスは以下の通りです。
    1.  カスタムプロトコルハンドラ（`abematv-license://`）で、動画マニフェストからのライセンスリクエストを傍受します。
    2.  AbemaTVのライセンスサーバーにライセンスを要求します。
    3.  サーバーは暗号化された動画鍵を返します。この鍵は、**カスタムのBase58形式の文字列**でエンコードされています。
    4.  エクストラクタはこの鍵をデコードします。
    5.  次に、**AES-ECB**を用いて鍵を復号します。このステップの復号鍵自体が、別のハードコードされた鍵（`_HKEY`）、デバイスID、およびライセンス応答に含まれる`cid`を用いたHMAC-SHA256ハッシュによって生成されます。
    6.  最終的に得られた16バイトの復号鍵が、動画ストリームのダウンロードに使用されます。

## 結論

**はい、AbemaTVは`yt-dlp`にとってターゲット可能なプラットフォームですが、TVerとは根本的に異なり、はるかに複雑です。**

*   **TVer:** 標準的な外部ビデオプラットフォームを使用しているため、サポートが容易です。エクストラクタはシンプルで保守性も高いです。
*   **AbemaTV:** 完全にカスタムされた独自のDRMシステムを使用しているため、サポートが困難です。`yt-dlp`のエクストラクタは、高度なリバースエンジニアリングの成果物です。

これは、AbemaTVのエクストラクタが**脆弱である**ことを意味します。もしAbemaTVがカスタムDRMのいずれかの部分（例: 秘密鍵の更新、ハッシュアルゴリズムの変更、ライセンスプロトコルの変更）を変更した場合、エクストラクタは即座に機能しなくなり、修正には多大なリバースエンジニアリングの労力が必要となります。TVerは、その基盤となるプラットフォームプロバイダ（Brightcove, Streaks）が`yt-dlp`でサポートされ続ける限り、このような変更に対してより耐性があります。
